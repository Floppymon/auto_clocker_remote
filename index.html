<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auto Clocker Remote</title>
    <meta name="theme-color" content="#f8f9fa">
    
    <link rel="icon" href="data:,">
    
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQXV0byBDbG9ja2VyIFJlbW90ZSIsInNob3J0X25hbWUiOiJDbG9ja2VyIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMmVkNTczIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS8xOTIiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    <style>
        /* --- COPY OF POPUP.CSS --- */
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f8f9fa; 
            color: #333; 
            margin: 0;
            padding: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        h3 { margin: 0 0 20px 0; font-size: 18px; font-weight: 800; color: #636e72; text-align: center; }

        /* Inputs */
        .input-group { margin-bottom: 20px; text-align: center; display: flex; justify-content: center; flex-direction: column; width: 100%; }
        .time-row { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px; }
        .time-col { display: flex; flex-direction: column; flex: 1; }
        .time-col label { font-size: 11px; font-weight: 700; color: #636e72; margin-bottom: 4px; text-align: left; }
        
        input[type="time"], input[type="text"] { 
            width: 100%; padding: 10px; font-size: 16px; font-weight: 600; font-family: inherit; 
            text-align: center; border: 2px solid #dfe6e9; border-radius: 10px; 
            background-color: #fff; outline: none; color: #2d3436; 
            transition: border-color 0.2s; -webkit-appearance: none;
        }
        input:focus { border-color: #2ed573; }
        input[type="text"] { text-align: left; font-weight: 400; font-size: 14px; }

        /* Calendar */
        .calendar-wrapper { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #dfe6e9; margin-bottom: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: 600; font-size: 14px; }
        .calendar-header button { width: 32px; height: 32px; padding: 0; background: transparent; color: #636e72; border-radius: 4px; border: none; font-size: 16px; cursor: pointer; }
        .calendar-grid-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 10px; font-weight: 700; color: #b2bec3; margin-bottom: 5px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day { height: 36px; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 6px; cursor: pointer; color: #2d3436; transition: background 0.1s; }
        .cal-day:active { background-color: #f1f2f6; }
        .cal-day.selected { background-color: #2ed573; color: white; font-weight: 600; box-shadow: 0 2px 4px rgba(46, 213, 115, 0.3); }
        .cal-day.today { border: 1px solid #2ed573; }
        .cal-day.past { color: #b2bec3; pointer-events: none; background-color: #fdfdfd; }
        .cal-day.empty { pointer-events: none; }

        /* Settings Block */
        .settings-block { background: #fff; border: 1px solid #dfe6e9; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .setting-row:last-child { margin-bottom: 0; }
        .setting-label { font-size: 14px; font-weight: 600; color: #636e72; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ed573; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Action Button */
        button.action-btn { width: 100%; padding: 14px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; border-radius: 12px; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background-color: #2ed573; color: white; }
        button.action-btn:active { transform: scale(0.98); background-color: #26af61; }

        #status { margin-top: 20px; font-size: 13px; text-align: center; font-weight: 500; min-height: 20px; }
        .text-error { color: #ff4757; }
        .text-success { color: #2ed573; }
    </style>
</head>
<body>

    <h3>Auto Clocker Remote</h3>

    <div class="input-group">
        <div class="time-row">
            <div class="time-col">
                <label>Clock IN</label>
                <input type="time" id="clockInTime">
            </div>
            <div class="time-col">
                <label>Clock OUT</label>
                <input type="time" id="clockOutTime">
            </div>
        </div>

        <div class="calendar-wrapper">
            <div class="calendar-header">
                <button id="prevMonthBtn">&lt;</button>
                <span id="currentMonthLabel"></span>
                <button id="nextMonthBtn">&gt;</button>
            </div>
            <div class="calendar-grid-header">
                <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <div class="settings-block">
            <div class="setting-row">
                <span class="setting-label">Randomise time (Â±5m)</span>
                <label class="switch">
                    <input type="checkbox" id="randomizeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="time-col">
                <label style="margin-bottom: 8px;">Ntfy Topic</label>
                <input type="text" id="ntfyTopicInput" placeholder="Enter topic name...">
            </div>
        </div>
    </div>
    
    <button id="actionBtn" class="action-btn" onclick="sendSchedule()">Update PC Schedule</button>
    
    <div id="status"></div>

    <script>
        // --- STATE ---
        let currentDate = new Date(); 
        let selectedDates = []; 

        // --- DOM ---
        const clockInInput = document.getElementById('clockInTime');
        const clockOutInput = document.getElementById('clockOutTime');
        const ntfyInput = document.getElementById('ntfyTopicInput');
        const randomizeToggle = document.getElementById('randomizeToggle');
        const calGrid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('currentMonthLabel');
        const statusEl = document.getElementById('status');

        // --- LOAD SETTINGS ---
        const storedTopic = localStorage.getItem('ntfyTopic');
        if(storedTopic) ntfyInput.value = storedTopic;

        const storedRandom = localStorage.getItem('isRandomized');
        if(storedRandom === 'true') randomizeToggle.checked = true;

        // Auto-save listeners
        ntfyInput.addEventListener('input', () => localStorage.setItem('ntfyTopic', ntfyInput.value.trim()));
        randomizeToggle.addEventListener('change', () => localStorage.setItem('isRandomized', randomizeToggle.checked));

        // --- CALENDAR LOGIC ---
        function renderCalendar(date) {
            calGrid.innerHTML = "";
            const year = date.getFullYear();
            const month = date.getMonth();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthLabel.textContent = `${monthNames[month]} ${year}`;

            const firstDayIndex = new Date(year, month, 1).getDay(); 
            const lastDay = new Date(year, month + 1, 0).getDate();
            const todayDate = new Date(); todayDate.setHours(0,0,0,0);

            for (let i = 0; i < firstDayIndex; i++) {
                const el = document.createElement("div");
                el.className = "cal-day empty";
                calGrid.appendChild(el);
            }

            for (let i = 1; i <= lastDay; i++) {
                const el = document.createElement("div");
                el.textContent = i;
                el.className = "cal-day";
                
                const checkDate = new Date(year, month, i);
                const y = checkDate.getFullYear();
                const m = String(checkDate.getMonth() + 1).padStart(2, '0');
                const d = String(checkDate.getDate()).padStart(2, '0');
                const dateStr = `${y}-${m}-${d}`;

                if (checkDate < todayDate) el.classList.add("past");
                else {
                    el.onclick = () => {
                        if (selectedDates.includes(dateStr)) {
                            selectedDates = selectedDates.filter(d => d !== dateStr);
                            el.classList.remove("selected");
                        } else {
                            selectedDates.push(dateStr);
                            el.classList.add("selected");
                        }
                    };
                    if (selectedDates.includes(dateStr)) el.classList.add("selected");
                    if (dateStr === new Date().toISOString().split('T')[0]) el.classList.add("today");
                }
                calGrid.appendChild(el);
            }
        }

        document.getElementById('prevMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); };
        document.getElementById('nextMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); };
        
        renderCalendar(currentDate);

        // --- DUAL SEND LOGIC ---
        async function sendSchedule() {
            const topic = ntfyInput.value.trim();
            const inTime = clockInInput.value;
            const outTime = clockOutInput.value;
            const isRandom = randomizeToggle.checked;

            if(!topic) return showStatus("Please enter a Ntfy Topic.", "error");
            if(selectedDates.length === 0) return showStatus("Select at least one date.", "error");
            if(!inTime && !outTime) return showStatus("Set at least one time.", "error");

            // 1. Prepare Payload (For PC)
            const payload = {
                type: "REMOTE_UPDATE",
                dates: selectedDates.sort(),
                clockIn: inTime,
                clockOut: outTime,
                isRandomized: isRandom
            };

            // 2. Prepare Human Message (For your Phone Notification)
            // Convert dates to short strings e.g. "25, 26"
            const dateDisplays = selectedDates.map(d => d.split('-')[2]).join(", ");
            const humanBody = `IN: ${inTime || '--'} | OUT: ${outTime || '--'}\nDays: ${dateDisplays}\n${isRandom ? '(Randomised)' : ''}`;

            showStatus("Sending...", "normal");

            try {
                // --- REQUEST 1: SILENT DATA (Priority 1) ---
                // This is what the Extension reads. Your phone should ignore/silence this.
                await fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 
                        'Title': 'Internal_Data', 
                        'Priority': '1', // Min priority (Silent)
                        'Tags': 'gear'
                    }
                });

                // --- REQUEST 2: VISIBLE NOTIFICATION (Priority 4) ---
                // This is what YOU read. The Extension ignores this because it's not JSON with "REMOTE_UPDATE".
                await fetch(`https://ntfy.sh/${topic}`, {
                    method: 'POST',
                    body: humanBody,
                    headers: { 
                        'Title': 'Schedule Updated', 
                        'Priority': '4', // High priority (Visible)
                        'Tags': 'calendar' 
                    }
                });

                showStatus("Sent! PC syncing...", "success");

            } catch (err) {
                showStatus("Network Error.", "error");
            }
        }

        function showStatus(msg, type) {
            statusEl.textContent = msg;
            statusEl.className = type === "error" ? "text-error" : (type === "success" ? "text-success" : "");
        }
    </script>
</body>
</html>